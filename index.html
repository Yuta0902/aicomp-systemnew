<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI COMP å–æ¬¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a2e;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(88, 101, 242, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #e5e7eb;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: rgba(30, 32, 48, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 25px 40px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translateY(-30px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 1.8em;
            font-weight: 300;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ffffff 0%, #d1d5db 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 0.9em;
            font-weight: 300;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
        }

        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #7c7c8e 0%, #4a4a5e 100%);
            color: #fff;
            padding: 4px 14px;
            border-radius: 16px;
            font-size: 0.45em;
            font-weight: 400;
            letter-spacing: 1px;
            margin-left: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 10px #4ade80;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 10px #4ade80;
            }
            50% { 
                opacity: 0.6;
                box-shadow: 0 0 20px #4ade80;
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(30, 32, 48, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 28px;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.6), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .stat-card:hover::before {
            transform: translateX(100%);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 20px 60px rgba(139, 92, 246, 0.2);
        }

        .stat-label {
            color: #9ca3af;
            font-size: 0.75em;
            font-weight: 400;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 300;
            background: linear-gradient(135deg, #ffffff 0%, #d1d5db 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-detail {
            margin-top: 8px;
            font-size: 0.8em;
            color: #6b7280;
            font-weight: 300;
        }

        .controls {
            background: rgba(30, 32, 48, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 40px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-weight: 400;
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #5956d6 0%, #4a4a7c 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(89, 86, 214, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(74, 222, 128, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(96, 165, 250, 0.4);
        }

        .search-box {
            flex: 1;
            min-width: 320px;
        }

        .search-box input {
            width: 100%;
            padding: 14px 24px;
            background: rgba(45, 48, 65, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            font-size: 0.95em;
            color: #e5e7eb;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .search-box input::placeholder {
            color: #9ca3af;
        }

        .search-box input:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
            background: rgba(55, 58, 75, 0.9);
        }

        .table-container {
            background: rgba(30, 32, 48, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 40px;
            border-radius: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        thead {
            background: rgba(45, 48, 65, 0.9);
        }

        th {
            padding: 18px 20px;
            text-align: left;
            font-weight: 400;
            font-size: 0.85em;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #9ca3af;
            cursor: pointer;
            user-select: none;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }

        th:first-child {
            border-top-left-radius: 12px;
        }

        th:last-child {
            border-top-right-radius: 12px;
        }

        th:hover {
            background: rgba(55, 58, 75, 0.9);
            color: #e5e7eb;
        }

        th.sortable::after {
            content: 'â‡…';
            opacity: 0.4;
            margin-left: 8px;
            font-size: 0.9em;
        }

        th.sort-asc::after {
            content: 'â–²';
            opacity: 1;
            color: #8b5cf6;
        }

        th.sort-desc::after {
            content: 'â–¼';
            opacity: 1;
            color: #8b5cf6;
        }

        tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        tbody tr:hover {
            background: rgba(45, 48, 65, 0.5);
        }

        td {
            padding: 20px;
            color: #d1d5db;
            font-size: 0.95em;
        }

        td strong {
            color: #f3f4f6;
            font-weight: 400;
        }

        .badge {
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 400;
            letter-spacing: 0.5px;
            display: inline-block;
            border: 1px solid;
        }

        .badge-active {
            background: rgba(74, 222, 128, 0.15);
            color: #4ade80;
            border-color: rgba(74, 222, 128, 0.3);
        }

        .badge-pending {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.3);
        }

        .badge-suspended {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .badge-paid {
            background: rgba(74, 222, 128, 0.15);
            color: #4ade80;
            border-color: rgba(74, 222, 128, 0.3);
        }

        .badge-unpaid {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.3);
        }

        .badge-overdue {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .plan-business {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
            border-color: rgba(96, 165, 250, 0.3);
        }

        .plan-3month {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
            border-color: rgba(168, 85, 247, 0.3);
        }

        .plan-6month {
            background: rgba(236, 72, 153, 0.15);
            color: #ec4899;
            border-color: rgba(236, 72, 153, 0.3);
        }

        .plan-12month {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(30, 32, 48, 0.98);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 50px;
            border-radius: 24px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(50px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }

        .modal-content h2 {
            font-size: 2em;
            font-weight: 300;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #ffffff 0%, #d1d5db 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 30px 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 10px;
            font-weight: 400;
            color: #9ca3af;
            font-size: 0.85em;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 14px 18px;
            background: rgba(45, 48, 65, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            font-size: 0.95em;
            color: #e5e7eb;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
            background: rgba(55, 58, 75, 0.9);
        }

        .form-actions {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 40px;
        }

        .btn-secondary {
            background: rgba(60, 60, 70, 0.8);
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(70, 70, 80, 0.9);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .actions {
            display: flex;
            gap: 12px;
        }

        .btn-sm {
            padding: 10px 20px;
            font-size: 0.85em;
            border-radius: 10px;
        }

        .btn-edit {
            background: linear-gradient(135deg, #5956d6 0%, #4a4a7c 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-delete {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .file-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 50px;
            text-align: center;
            background: rgba(40, 40, 50, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            background: rgba(50, 50, 60, 0.6);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .file-upload-area.dragover {
            background: rgba(60, 60, 70, 0.8);
            border-color: #60a5fa;
        }

        input[type="file"] {
            display: none;
        }

        .alert {
            padding: 18px 24px;
            border-radius: 12px;
            margin: 24px 0;
            font-weight: 400;
            border: 1px solid;
        }

        .alert-success {
            background: rgba(74, 222, 128, 0.15);
            color: #4ade80;
            border-color: rgba(74, 222, 128, 0.3);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 15px;
            }

            h1 {
                font-size: 1.5em;
            }
            
            .header {
                padding: 20px 25px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-value {
                font-size: 1.8em;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .search-box {
                width: 100%;
            }

            .modal-content {
                padding: 30px 25px;
            }
        }

        @media (max-width: 1400px) {
            .stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1400px) {
            .stats {
                grid-template-columns: repeat(5, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                AI COMP å–æ¬¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
                <span class="version-badge">VERSION 2.0</span>
            </h1>
            <p class="subtitle">
                <span class="status-indicator"></span>
                å¥‘ç´„ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">ç·å¥‘ç´„æ•°</div>
                <div class="stat-value" id="totalContracts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¥‘ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <div class="stat-value" id="activeContracts">0</div>
                <div class="stat-detail" id="statusDetail">æœ‰åŠ¹: 0 / ä¿ç•™: 0 / ä¸­æ–­: 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <div class="stat-value" id="paidContracts">0</div>
                <div class="stat-detail" id="paymentDetail">æ”¯æ‰•æ¸ˆ: 0 / æœªæ‰•: 0 / å»¶æ»: 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å½“æœˆç²å¾—å£²ä¸Š</div>
                <div class="stat-value" id="currentMonthRevenue">Â¥0</div>
                <div class="stat-detail" id="currentMonthDetail">2025å¹´11æœˆç²å¾— (0ä»¶)</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç´¯è¨ˆå£²ä¸Šï¼ˆæœ‰åŠ¹å¥‘ç´„ï¼‰</div>
                <div class="stat-value" id="totalRevenue">Â¥0</div>
                <div class="stat-detail">æœˆæ¬¡åç›Šåˆè¨ˆ</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="openModal()">
                æ–°è¦å¥‘ç´„ç™»éŒ²
            </button>
            <button class="btn btn-info" onclick="openImportModal()">
                æ”¯æ‰•ã„çŠ¶æ³ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            </button>
            <button class="btn btn-success" onclick="exportCSV()">
                CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <button class="btn btn-info" onclick="openSalesModal()">
                å–¶æ¥­æ‹…å½“è€…ç®¡ç†
            </button>
            <button class="btn btn-primary" onclick="loadContracts()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                ğŸ”„ æ›´æ–°
            </button>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æ¤œç´¢ï¼ˆç¤¾åãƒ»æ‹…å½“è€…ãƒ»é›»è©±ç•ªå·ï¼‰..." onkeyup="filterTable()">
            </div>
        </div>

        <div class="table-container">
            <table id="contractsTable">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('inputDate')">å…¥åŠ›æ—¥</th>
                        <th class="sortable" onclick="sortTable('companyName')">é¡§å®¢æ³•äººå</th>
                        <th class="sortable" onclick="sortTable('plan')">ãƒ—ãƒ©ãƒ³</th>
                        <th class="sortable" onclick="sortTable('monthlyFee')">æœˆé¡æ–™é‡‘</th>
                        <th class="sortable" onclick="sortTable('startDate')">å¥‘ç´„é–‹å§‹æ—¥</th>
                        <th class="sortable" onclick="sortTable('status')">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th class="sortable" onclick="sortTable('paymentStatus')">æ”¯æ‰•çŠ¶æ³</th>
                        <th class="sortable" onclick="sortTable('salesPerson')">å–¶æ¥­æ‹…å½“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="contractsBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- å¥‘ç´„ç™»éŒ²ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="contractModal">
        <div class="modal-content">
            <h2>å¥‘ç´„æƒ…å ±å…¥åŠ›</h2>
            <form id="contractForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ä¼šç¤¾å *</label>
                        <input type="text" name="companyName" required>
                    </div>
                    <div class="form-group">
                        <label>æ‹…å½“è€…å *</label>
                        <input type="text" name="contactPerson" required>
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>é›»è©±ç•ªå·</label>
                        <input type="tel" name="phone">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>ä½æ‰€</label>
                        <input type="text" name="address">
                    </div>
                    <div class="form-group">
                        <label>ãƒ—ãƒ©ãƒ³ *</label>
                        <select name="plan" required onchange="updateFee(this.value)">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ©ãƒ³">ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ©ãƒ³</option>
                            <option value="3ãƒ¶æœˆç„¡æ–™">3ãƒ¶æœˆç„¡æ–™</option>
                            <option value="6ãƒ¶æœˆç„¡æ–™">6ãƒ¶æœˆç„¡æ–™</option>
                            <option value="12ãƒ¶æœˆç„¡æ–™">12ãƒ¶æœˆç„¡æ–™</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æœˆé¡æ–™é‡‘ (å††) *</label>
                        <input type="number" name="monthlyFee" id="monthlyFee" required>
                    </div>
                    <div class="form-group">
                        <label>å…¥åŠ›æ—¥ *</label>
                        <input type="date" name="inputDate" id="inputDate" required>
                    </div>
                    <div class="form-group">
                        <label>å¥‘ç´„é–‹å§‹æ—¥ *</label>
                        <input type="date" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label>æ¬¡å›è«‹æ±‚æ—¥ *</label>
                        <input type="date" name="nextBillingDate" required>
                    </div>
                    <div class="form-group">
                        <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ *</label>
                        <select name="status" required>
                            <option value="æœ‰åŠ¹">æœ‰åŠ¹</option>
                            <option value="ä¿ç•™ä¸­">ä¿ç•™ä¸­</option>
                            <option value="ä¸­æ–­">ä¸­æ–­</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ”¯æ‰•çŠ¶æ³ *</label>
                        <select name="paymentStatus" required>
                            <option value="æœªæ‰•ã„">æœªæ‰•ã„</option>
                            <option value="æ”¯æ‰•æ¸ˆ">æ”¯æ‰•æ¸ˆ</option>
                            <option value="å»¶æ»">å»¶æ»</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ”¯æ‰•æ–¹æ³• *</label>
                        <select name="paymentMethod" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
                            <option value="å£åº§æŒ¯æ›¿">å£åº§æŒ¯æ›¿</option>
                            <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å–¶æ¥­æ‹…å½“ *</label>
                        <select name="salesPerson" id="salesPersonSelect" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-success">ç™»éŒ²ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2>æ”¯æ‰•ã„çŠ¶æ³ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
            <p style="color: #888; margin-bottom: 25px; line-height: 1.6;">
                ä»¥ä¸‹ã®å½¢å¼ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼š<br>
                <strong style="color: #ccc;">å¥‘ç´„ID, æ”¯æ‰•çŠ¶æ³</strong><br>
                ä¾‹: AC-2025-0001, æ”¯æ‰•æ¸ˆ
            </p>
            
            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;">ğŸ“</div>
                <div style="font-size: 1.2em; font-weight: 400; margin-bottom: 10px; color: #ccc;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
                <div style="color: #666;">ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
                <input type="file" id="fileInput" accept=".csv,.txt" onchange="handleFileUpload(event)">
            </div>

            <div id="importPreview" style="display: none; margin-top: 25px;">
                <h3 style="margin-bottom: 15px; color: #ccc; font-weight: 400; font-size: 1.1em;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <textarea id="previewText" rows="10" style="width: 100%; padding: 18px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(40,40,50,0.6); color: #ccc; font-family: monospace;" readonly></textarea>
            </div>

            <div id="importAlert"></div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-success" id="importBtn" onclick="processImport()" style="display: none;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <!-- å–¶æ¥­æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="salesModal">
        <div class="modal-content">
            <h2>å–¶æ¥­æ‹…å½“è€…ç®¡ç†</h2>
            
            <div style="margin: 30px 0;">
                <h3 style="color: #ccc; font-weight: 400; font-size: 1.1em; margin-bottom: 20px;">ç¾åœ¨ã®å–¶æ¥­æ‹…å½“è€…</h3>
                <div id="salesPersonList" style="display: flex; flex-direction: column; gap: 12px;"></div>
            </div>

            <div style="margin: 30px 0;">
                <h3 style="color: #ccc; font-weight: 400; font-size: 1.1em; margin-bottom: 20px;">æ–°è¦è¿½åŠ </h3>
                <div style="display: flex; gap: 12px;">
                    <input type="text" id="newSalesPersonName" placeholder="å–¶æ¥­æ‹…å½“è€…å" style="flex: 1; padding: 14px 18px; background: rgba(40, 40, 50, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; font-size: 0.95em; color: #ffffff;">
                    <button class="btn btn-success" onclick="addSalesPerson()">è¿½åŠ </button>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeSalesModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- é¡§å®¢è©³ç´°ãƒ»å¯¾å¿œå±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="detailModal">
        <div class="modal-content" style="max-width: 1200px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 id="detailCompanyName" style="margin: 0;">é¡§å®¢è©³ç´°</h2>
                <button class="btn btn-secondary" onclick="closeDetailModal()">âœ•</button>
            </div>

            <!-- åŸºæœ¬æƒ…å ± -->
            <div style="background: rgba(45, 48, 65, 0.5); padding: 25px; border-radius: 12px; margin-bottom: 30px;">
                <h3 style="color: #9ca3af; font-size: 0.9em; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">åŸºæœ¬æƒ…å ±</h3>
                <div id="detailBasicInfo" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;"></div>
            </div>

            <!-- å¯¾å¿œå±¥æ­´ -->
            <div style="background: rgba(45, 48, 65, 0.5); padding: 25px; border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #9ca3af; font-size: 0.9em; margin: 0; text-transform: uppercase; letter-spacing: 1px;">å¯¾å¿œå±¥æ­´</h3>
                    <button class="btn btn-sm btn-primary" onclick="openHistoryForm()">æ–°è¦è¿½åŠ </button>
                </div>

                <!-- å±¥æ­´è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="historyForm" style="display: none; background: rgba(30, 32, 48, 0.8); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(139, 92, 246, 0.3);">
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; color: #9ca3af; font-size: 0.85em; margin-bottom: 8px;">å¯¾å¿œå†…å®¹ *</label>
                            <textarea id="historyContent" rows="3" style="width: 100%; padding: 12px; background: rgba(45, 48, 65, 0.8); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; color: #e5e7eb; resize: vertical;" placeholder="å¯¾å¿œå†…å®¹ã‚’å…¥åŠ›..."></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-sm btn-secondary" onclick="closeHistoryForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button class="btn btn-sm btn-success" onclick="addHistory()">è¿½åŠ </button>
                        </div>
                    </div>
                </div>

                <!-- å±¥æ­´ä¸€è¦§ -->
                <div id="historyList" style="display: flex; flex-direction: column; gap: 15px; max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        let contracts = [];
        let editingId = null;
        let importData = null;
        let sortColumn = null;
        let sortDirection = 'asc';
        let salesPersons = ['æ¹¯æµ… æ™ƒå¹³', 'éˆ´æœ¨ å‹æ¢¨éŸ³', 'æŸ³ç€¬ æ™ºæ–‡', 'é«˜å±± å°†æ˜']; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

        // LocalStorageã‹ã‚‰å–¶æ¥­æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
        function loadSalesPersons() {
            const saved = localStorage.getItem('salesPersons');
            if (saved) {
                salesPersons = JSON.parse(saved);
            }
        }

        // LocalStorageã«å–¶æ¥­æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’ä¿å­˜
        function saveSalesPersons() {
            localStorage.setItem('salesPersons', JSON.stringify(salesPersons));
        }

        // å–¶æ¥­æ‹…å½“è€…ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
        function updateSalesPersonSelect() {
            const select = document.getElementById('salesPersonSelect');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            salesPersons.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                select.appendChild(option);
            });
        }

        // å–¶æ¥­æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function renderSalesPersonList() {
            const list = document.getElementById('salesPersonList');
            list.innerHTML = '';
            
            salesPersons.forEach((person, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; background: rgba(40, 40, 50, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;';
                item.innerHTML = `
                    <span style="color: #ccc; font-size: 0.95em;">${person}</span>
                    <button class="btn btn-sm btn-delete" onclick="removeSalesPerson(${index})" style="padding: 6px 12px;">å‰Šé™¤</button>
                `;
                list.appendChild(item);
            });
        }

        // å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ 
        function addSalesPerson() {
            const input = document.getElementById('newSalesPersonName');
            const name = input.value.trim();
            
            if (!name) {
                alert('å–¶æ¥­æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (salesPersons.includes(name)) {
                alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            salesPersons.push(name);
            saveSalesPersons();
            updateSalesPersonSelect();
            renderSalesPersonList();
            input.value = '';
        }

        // å–¶æ¥­æ‹…å½“è€…ã‚’å‰Šé™¤
        function removeSalesPerson(index) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            salesPersons.splice(index, 1);
            saveSalesPersons();
            updateSalesPersonSelect();
            renderSalesPersonList();
        }

        // å–¶æ¥­æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openSalesModal() {
            renderSalesPersonList();
            document.getElementById('salesModal').classList.add('active');
        }

        function closeSalesModal() {
            document.getElementById('salesModal').classList.remove('active');
        }

        // é¡§å®¢è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
        let currentContractId = null;

        async function openDetailModal(contractId) {
            currentContractId = contractId;
            const contract = contracts.find(c => c.id === contractId);
            
            if (!contract) return;

            // åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('detailCompanyName').textContent = contract.companyName;
            
            const basicInfo = document.getElementById('detailBasicInfo');
            basicInfo.innerHTML = `
                <div><div style="color: #6b7280; font-size: 0.85em; margin-bottom: 5px;">æ‹…å½“è€…</div><div style="color: #e5e7eb;">${contract.contactPerson || '-'}</div></div>
                <div><div style="color: #6b7280; font-size: 0.85em; margin-bottom: 5px;">ãƒ¡ãƒ¼ãƒ«</div><div style="color: #e5e7eb;">${contract.email || '-'}</div></div>
                <div><div style="color: #6b7280; font-size: 0.85em; margin-bottom: 5px;">é›»è©±</div><div style="color: #e5e7eb;">${contract.phone || '-'}</div></div>
                <div><div style="color: #6b7280; font-size: 0.85em; margin-bottom: 5px;">ãƒ—ãƒ©ãƒ³</div><div style="color: #e5e7eb;">${contract.plan}</div></div>
                <div><div style="color: #6b7280; font-size: 0.85em; margin-bottom: 5px;">æœˆé¡æ–™é‡‘</div><div style="color: #e5e7eb;">Â¥${contract.monthlyFee.toLocaleString()}</div></div>
                <div><div style="color: #6b7280; font-size: 0.85em; margin-bottom: 5px;">å–¶æ¥­æ‹…å½“</div><div style="color: #e5e7eb;">${contract.salesPerson}</div></div>
                <div><div style="color: #6b7280; font-size: 0.85em; margin-bottom: 5px;">å¥‘ç´„é–‹å§‹æ—¥</div><div style="color: #e5e7eb;">${contract.startDate}</div></div>
                <div><div style="color: #6b7280; font-size: 0.85em; margin-bottom: 5px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div><div style="color: #e5e7eb;">${contract.status}</div></div>
                <div><div style="color: #6b7280; font-size: 0.85em; margin-bottom: 5px;">æ”¯æ‰•çŠ¶æ³</div><div style="color: #e5e7eb;">${contract.paymentStatus || 'æœªæ‰•ã„'}</div></div>
            `;

            // å¯¾å¿œå±¥æ­´ã‚’èª­ã¿è¾¼ã¿
            await loadHistory(contractId);
            
            // æ—¢èª­ãƒãƒ¼ã‚¯ã‚’ã¤ã‘ã‚‹
            await fetch(`/api/contracts/${contractId}/mark-read`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            // å¥‘ç´„ä¸€è¦§ã‚’æ›´æ–°ã—ã¦æ–°ç€ãƒãƒƒã‚¸ã‚’æ¶ˆã™
            await loadContracts();

            document.getElementById('detailModal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
            currentContractId = null;
            closeHistoryForm();
        }

        function openHistoryForm() {
            document.getElementById('historyForm').style.display = 'block';
            document.getElementById('historyContent').value = '';
            document.getElementById('historyContent').focus();
        }

        function closeHistoryForm() {
            document.getElementById('historyForm').style.display = 'none';
            document.getElementById('historyContent').value = '';
        }

        async function loadHistory(contractId) {
            try {
                const response = await fetch(`/api/contracts/${contractId}/history`);
                const history = await response.json();
                
                renderHistory(history);
            } catch (error) {
                console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function renderHistory(history) {
            const listDiv = document.getElementById('historyList');
            
            if (!history || history.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">å¯¾å¿œå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            listDiv.innerHTML = history.map(item => `
                <div style="background: rgba(30, 32, 48, 0.6); padding: 20px; border-radius: 8px; border-left: 3px solid #8b5cf6;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <span style="color: #8b5cf6; font-weight: 500;">${item.userName}</span>
                            <span style="color: #6b7280; font-size: 0.85em;">${item.createdAt}</span>
                        </div>
                        <button class="btn btn-sm btn-delete" onclick="deleteHistory('${item.id}')" style="padding: 4px 10px; font-size: 0.8em;">å‰Šé™¤</button>
                    </div>
                    <div style="color: #d1d5db; line-height: 1.6; white-space: pre-wrap;">${item.content}</div>
                </div>
            `).join('');
        }

        async function addHistory() {
            const content = document.getElementById('historyContent').value.trim();
            
            if (!content) {
                alert('å¯¾å¿œå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                await fetch(`/api/contracts/${currentContractId}/history`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                closeHistoryForm();
                await loadHistory(currentContractId);
            } catch (error) {
                console.error('å±¥æ­´è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('å±¥æ­´ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function deleteHistory(historyId) {
            if (!confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                await fetch(`/api/contracts/${currentContractId}/history/${historyId}`, {
                    method: 'DELETE'
                });

                await loadHistory(currentContractId);
            } catch (error) {
                console.error('å±¥æ­´å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å±¥æ­´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadContracts() {
            try {
                const response = await fetch('/api/contracts');
                contracts = await response.json();
                renderTable();
                await updateStats();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // çµ±è¨ˆæ›´æ–°
        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                document.getElementById('totalContracts').textContent = stats.total;
                document.getElementById('activeContracts').textContent = stats.byStatus.active;
                document.getElementById('statusDetail').textContent = 
                    `æœ‰åŠ¹: ${stats.byStatus.active} / ä¿ç•™: ${stats.byStatus.pending} / ä¸­æ–­: ${stats.byStatus.suspended}`;
                
                document.getElementById('paidContracts').textContent = stats.byPaymentStatus.paid;
                document.getElementById('paymentDetail').textContent = 
                    `æ”¯æ‰•æ¸ˆ: ${stats.byPaymentStatus.paid} / æœªæ‰•: ${stats.byPaymentStatus.unpaid} / å»¶æ»: ${stats.byPaymentStatus.overdue}`;
                
                // å½“æœˆç²å¾—å£²ä¸Šã‚’è¨ˆç®—ï¼ˆå…¥åŠ›æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const currentMonthStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                
                let currentMonthRevenue = 0;
                let currentMonthCount = 0;
                contracts.forEach(contract => {
                    if (contract.inputDate) {
                        const inputMonth = contract.inputDate.substring(0, 7); // YYYY-MM
                        if (inputMonth === currentMonthStr) {
                            currentMonthRevenue += contract.monthlyFee;
                            currentMonthCount++;
                        }
                    }
                });
                
                document.getElementById('currentMonthRevenue').textContent = 'Â¥' + currentMonthRevenue.toLocaleString();
                document.getElementById('currentMonthDetail').textContent = `${currentYear}å¹´${currentMonth}æœˆç²å¾— (${currentMonthCount}ä»¶)`;
                
                // ç´¯è¨ˆå£²ä¸Šï¼ˆå…¨ã¦ã®æœ‰åŠ¹å¥‘ç´„ï¼‰
                document.getElementById('totalRevenue').textContent = 'Â¥' + stats.revenue.toLocaleString();
            } catch (error) {
                console.error('çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderTable() {
            const tbody = document.getElementById('contractsBody');
            tbody.innerHTML = '';
            
            contracts.forEach(contract => {
                const row = tbody.insertRow();
                
                // æœªèª­ã®å±¥æ­´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const hasUnread = contract.unreadHistoryCount && contract.unreadHistoryCount > 0;
                const unreadBadge = hasUnread ? `<span class="badge" style="background: #ef4444; margin-left: 8px; animation: pulse 2s infinite;">æ–°ç€${contract.unreadHistoryCount}ä»¶</span>` : '';
                
                row.innerHTML = `
                    <td>${contract.inputDate || '-'}</td>
                    <td>
                        <strong style="color: #8b5cf6; cursor: pointer; text-decoration: underline;" onclick="openDetailModal('${contract.id}')">
                            ${contract.companyName}
                        </strong>
                        ${unreadBadge}
                    </td>
                    <td><span class="badge plan-${getPlanClass(contract.plan)}">${contract.plan}</span></td>
                    <td>Â¥${contract.monthlyFee.toLocaleString()}</td>
                    <td>${contract.startDate}</td>
                    <td><span class="badge badge-${getStatusClass(contract.status)}">${contract.status}</span></td>
                    <td><span class="badge badge-${getPaymentStatusClass(contract.paymentStatus || 'æœªæ‰•ã„')}">${contract.paymentStatus || 'æœªæ‰•ã„'}</span></td>
                    <td>${contract.salesPerson}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-edit" onclick="editContract('${contract.id}')">ç·¨é›†</button>
                        <button class="btn btn-sm btn-delete" onclick="confirmDelete('${contract.id}')">å‰Šé™¤</button>
                    </td>
                `;
            });
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            contracts.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // æ•°å€¤ã®å ´åˆ
                if (column === 'monthlyFee') {
                    aVal = parseInt(aVal);
                    bVal = parseInt(bVal);
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            // ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const headerMap = {
                'inputDate': 0, 'companyName': 1, 'plan': 2,
                'monthlyFee': 3, 'startDate': 4, 'status': 5,
                'paymentStatus': 6, 'salesPerson': 7
            };
            
            const thIndex = headerMap[column];
            if (thIndex !== undefined) {
                const th = document.querySelectorAll('th')[thIndex];
                th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            }

            renderTable();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
        function openModal() {
            editingId = null;
            document.getElementById('contractForm').reset();
            updateSalesPersonSelect();
            // å…¥åŠ›æ—¥ã‚’ä»Šæ—¥ã®æ—¥ä»˜ã«è¨­å®š
            document.getElementById('inputDate').valueAsDate = new Date();
            document.getElementById('contractModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('contractModal').classList.remove('active');
        }

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importBtn').style.display = 'none';
            document.getElementById('importAlert').innerHTML = '';
            document.getElementById('previewText').value = '';
            importData = null;
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const fileUploadArea = document.getElementById('fileUploadArea');
        
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                readFile(file);
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                readFile(file);
            }
        }

        function readFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                parseCSV(content);
            };
            reader.readAsText(file);
        }

        function parseCSV(content) {
            const lines = content.trim().split('\n');
            importData = [];
            let preview = '';

            lines.forEach((line, index) => {
                const [id, paymentStatus] = line.split(',').map(s => s.trim());
                if (id && paymentStatus) {
                    importData.push({ id, paymentStatus });
                    preview += `${index + 1}. ${id} â†’ ${paymentStatus}\n`;
                }
            });

            if (importData.length > 0) {
                document.getElementById('previewText').value = preview;
                document.getElementById('importPreview').style.display = 'block';
                document.getElementById('importBtn').style.display = 'inline-flex';
                document.getElementById('importAlert').innerHTML = 
                    `<div class="alert alert-success">${importData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</div>`;
            } else {
                document.getElementById('importAlert').innerHTML = 
                    `<div class="alert alert-error">ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</div>`;
            }
        }

        async function processImport() {
            if (!importData) return;

            try {
                const response = await fetch('/api/contracts/import-payment-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ updates: importData })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('importAlert').innerHTML = 
                        `<div class="alert alert-success">${result.updated}ä»¶ã®æ”¯æ‰•ã„çŠ¶æ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ</div>`;
                    
                    setTimeout(() => {
                        closeImportModal();
                        loadContracts();
                    }, 2000);
                }
            } catch (error) {
                console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('importAlert').innerHTML = 
                    `<div class="alert alert-error">ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('contractForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // æ•°å€¤å¤‰æ›
            data.monthlyFee = parseInt(data.monthlyFee);
            data.registrationDate = data.inputDate; // å…¥åŠ›æ—¥ã‚’ç™»éŒ²æ—¥ã¨ã—ã¦ä¿å­˜

            try {
                if (editingId) {
                    data.id = editingId;
                    await fetch(`/api/contracts/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    await fetch('/api/contracts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                closeModal();
                loadContracts();
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // ç·¨é›†
        async function editContract(id) {
            const contract = contracts.find(c => c.id === id);
            if (!contract) return;

            editingId = id;
            const form = document.getElementById('contractForm');
            
            updateSalesPersonSelect();
            
            Object.keys(contract).forEach(key => {
                const input = form.elements[key];
                if (input) input.value = contract[key] || '';
            });

            document.getElementById('contractModal').classList.add('active');
        }

        // å‰Šé™¤ç¢ºèªï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãï¼‰
        function confirmDelete(id) {
            const password = prompt('å‰Šé™¤ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
            
            if (password === null) {
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸ
                return;
            }
            
            if (password !== 'pass') {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
                return;
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„å ´åˆ
            if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                deleteContract(id);
            }
        }

        // å‰Šé™¤
        async function deleteContract(id) {
            try {
                await fetch(`/api/contracts/${id}`, { method: 'DELETE' });
                loadContracts();
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // æ¤œç´¢
        function filterTable() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#contractsBody tr');
            
            rows.forEach(row => {
                // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã§æ¤œç´¢
                const visibleText = row.textContent.toLowerCase();
                
                // å¥‘ç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›»è©±ç•ªå·ã‚’å–å¾—ã—ã¦æ¤œç´¢
                const strongElement = row.cells[1].querySelector('strong');
                if (strongElement) {
                    const onclickAttr = strongElement.getAttribute('onclick');
                    const match = onclickAttr.match(/'([^']+)'/);
                    if (match) {
                        const contractId = match[1];
                        const contract = contracts.find(c => c.id === contractId);
                        const phone = contract ? (contract.phone || '') : '';
                        
                        if (visibleText.includes(input) || phone.toLowerCase().includes(input)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                        return;
                    }
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                row.style.display = visibleText.includes(input) ? '' : 'none';
            });
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportCSV() {
            const headers = ['å¥‘ç´„ID', 'ä¼šç¤¾å', 'æ‹…å½“è€…', 'ãƒ¡ãƒ¼ãƒ«', 'é›»è©±', 'ä½æ‰€', 'ãƒ—ãƒ©ãƒ³', 'æœˆé¡æ–™é‡‘', 'é–‹å§‹æ—¥', 'æ¬¡å›è«‹æ±‚æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'æ”¯æ‰•çŠ¶æ³', 'æ”¯æ‰•æ–¹æ³•', 'å–¶æ¥­æ‹…å½“', 'ç™»éŒ²æ—¥'];
            const rows = contracts.map(c => [
                c.id, c.companyName, c.contactPerson, c.email, c.phone, c.address,
                c.plan, c.monthlyFee, c.startDate, c.nextBillingDate, c.status,
                c.paymentStatus || 'æœªæ‰•ã„', c.paymentMethod, c.salesPerson, c.registrationDate
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'contracts_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        // ãƒ—ãƒ©ãƒ³é¸æŠæ™‚ã®æ–™é‡‘è‡ªå‹•å…¥åŠ›
        function updateFee(plan) {
            const feeInput = document.getElementById('monthlyFee');
            const fees = {
                'ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ©ãƒ³': 6980,
                '3ãƒ¶æœˆç„¡æ–™': 6980,
                '6ãƒ¶æœˆç„¡æ–™': 71760,
                '12ãƒ¶æœˆç„¡æ–™': 71760
            };
            feeInput.value = fees[plan] || '';
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getPlanClass(plan) {
            if (plan.includes('ãƒ“ã‚¸ãƒã‚¹')) return 'business';
            if (plan.includes('3ãƒ¶æœˆ')) return '3month';
            if (plan.includes('6ãƒ¶æœˆ')) return '6month';
            if (plan.includes('12ãƒ¶æœˆ')) return '12month';
            return 'business';
        }

        function getStatusClass(status) {
            if (status === 'æœ‰åŠ¹') return 'active';
            if (status === 'ä¿ç•™ä¸­') return 'pending';
            if (status === 'ä¸­æ–­') return 'suspended';
            return 'active';
        }

        function getPaymentStatusClass(status) {
            if (status === 'æ”¯æ‰•æ¸ˆ') return 'paid';
            if (status === 'æœªæ‰•ã„') return 'unpaid';
            if (status === 'å»¶æ»') return 'overdue';
            return 'unpaid';
        }

        // åˆå›èª­ã¿è¾¼ã¿
        loadSalesPersons();
        updateSalesPersonSelect();
        loadContracts();
    </script>
</body>
</html>
