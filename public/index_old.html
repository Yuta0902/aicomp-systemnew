<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI COMP å–æ¬¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-badge {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.4em;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(56, 239, 125, 0.4);
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.3s ease;
            cursor: pointer;
        }

        tbody tr:hover {
            background: #f8f9ff;
        }

        td {
            padding: 15px;
        }

        .badge {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-active {
            background: #d4edda;
            color: #155724;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge-suspended {
            background: #f8d7da;
            color: #721c24;
        }

        .plan-business {
            background: #d1ecf1;
            color: #0c5460;
        }

        .plan-3month {
            background: #ffe5b4;
            color: #856404;
        }

        .plan-6month {
            background: #e7d4f5;
            color: #5a2a7a;
        }

        .plan-12month {
            background: #d4f5e7;
            color: #0a5a2a;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.85em;
            border-radius: 15px;
        }

        .btn-edit {
            background: #667eea;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                ğŸš€ AI COMP å–æ¬¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
                <span class="status-badge">é‹ç”¨ä¸­</span>
            </h1>
            <p style="color: #888; margin-top: 10px;">å¥‘ç´„ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š ç·å¥‘ç´„æ•°</div>
                <div class="stat-value" id="totalContracts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">âœ… æœ‰åŠ¹å¥‘ç´„</div>
                <div class="stat-value" id="activeContracts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ’° æœˆé¡åç›Šåˆè¨ˆ</div>
                <div class="stat-value" id="totalRevenue">Â¥0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ“ˆ å¹³å‡ãƒãƒ¼ã‚¸ãƒ³</div>
                <div class="stat-value" id="avgMargin">Â¥0</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="openModal()">
                â• æ–°è¦å¥‘ç´„ç™»éŒ²
            </button>
            <button class="btn btn-success" onclick="exportCSV()">
                ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” æ¤œç´¢... (ä¼šç¤¾åã€æ‹…å½“è€…ã€ãƒ¡ãƒ¼ãƒ«ãªã©)" onkeyup="filterTable()">
            </div>
        </div>

        <div class="table-container">
            <table id="contractsTable">
                <thead>
                    <tr>
                        <th>å¥‘ç´„ID</th>
                        <th>ä¼šç¤¾å</th>
                        <th>æ‹…å½“è€…</th>
                        <th>ãƒ—ãƒ©ãƒ³</th>
                        <th>æœˆé¡æ–™é‡‘</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th>å–¶æ¥­æ‹…å½“</th>
                        <th>ãƒãƒ¼ã‚¸ãƒ³</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="contractsBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="contractModal">
        <div class="modal-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“ å¥‘ç´„æƒ…å ±å…¥åŠ›</h2>
            <form id="contractForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ä¼šç¤¾å *</label>
                        <input type="text" name="companyName" required>
                    </div>
                    <div class="form-group">
                        <label>æ‹…å½“è€…å *</label>
                        <input type="text" name="contactPerson" required>
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>é›»è©±ç•ªå·</label>
                        <input type="tel" name="phone">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>ä½æ‰€</label>
                        <input type="text" name="address">
                    </div>
                    <div class="form-group">
                        <label>ãƒ—ãƒ©ãƒ³ *</label>
                        <select name="plan" required onchange="updateFee(this.value)">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ©ãƒ³">ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ©ãƒ³</option>
                            <option value="3ãƒ¶æœˆç„¡æ–™">3ãƒ¶æœˆç„¡æ–™</option>
                            <option value="6ãƒ¶æœˆç„¡æ–™">6ãƒ¶æœˆç„¡æ–™</option>
                            <option value="12ãƒ¶æœˆç„¡æ–™">12ãƒ¶æœˆç„¡æ–™</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æœˆé¡æ–™é‡‘ (å††) *</label>
                        <input type="number" name="monthlyFee" id="monthlyFee" required>
                    </div>
                    <div class="form-group">
                        <label>å¥‘ç´„é–‹å§‹æ—¥ *</label>
                        <input type="date" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label>æ¬¡å›è«‹æ±‚æ—¥ *</label>
                        <input type="date" name="nextBillingDate" required>
                    </div>
                    <div class="form-group">
                        <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ *</label>
                        <select name="status" required>
                            <option value="æœ‰åŠ¹">æœ‰åŠ¹</option>
                            <option value="ä¿ç•™ä¸­">ä¿ç•™ä¸­</option>
                            <option value="ä¸­æ–­">ä¸­æ–­</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ”¯æ‰•æ–¹æ³• *</label>
                        <select name="paymentMethod" required onchange="togglePaymentFields(this.value)">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
                            <option value="å£åº§æŒ¯æ›¿">å£åº§æŒ¯æ›¿</option>
                        </select>
                    </div>
                    <div class="form-group" id="cardNumberField" style="display:none;">
                        <label>ã‚«ãƒ¼ãƒ‰ç•ªå·</label>
                        <input type="text" name="cardNumber">
                    </div>
                    <div class="form-group" id="cardExpiryField" style="display:none;">
                        <label>ã‚«ãƒ¼ãƒ‰æœ‰åŠ¹æœŸé™</label>
                        <input type="text" name="cardExpiry" placeholder="MM/YYYY">
                    </div>
                    <div class="form-group" id="bankNameField" style="display:none;">
                        <label>éŠ€è¡Œå</label>
                        <input type="text" name="bankName">
                    </div>
                    <div class="form-group" id="accountNumberField" style="display:none;">
                        <label>å£åº§ç•ªå·</label>
                        <input type="text" name="accountNumber">
                    </div>
                    <div class="form-group">
                        <label>å–¶æ¥­æ‹…å½“ *</label>
                        <select name="salesPerson" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="æ¹¯æµ… æ™ƒå¹³">æ¹¯æµ… æ™ƒå¹³</option>
                            <option value="éˆ´æœ¨ å‹æ¢¨éŸ³">éˆ´æœ¨ å‹æ¢¨éŸ³</option>
                            <option value="æŸ³ç€¬ æ™ºæ–‡">æŸ³ç€¬ æ™ºæ–‡</option>
                            <option value="é«˜å±± å°†æ˜">é«˜å±± å°†æ˜</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åŸä¾¡ (å††) *</label>
                        <input type="number" name="cost" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-success">âœ… ç™»éŒ²ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let contracts = [];
        let editingId = null;

        // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadContracts() {
            try {
                const response = await fetch('/api/contracts');
                contracts = await response.json();
                renderTable();
                updateStats();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderTable() {
            const tbody = document.getElementById('contractsBody');
            tbody.innerHTML = '';
            
            contracts.forEach(contract => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${contract.id}</td>
                    <td><strong>${contract.companyName}</strong></td>
                    <td>${contract.contactPerson}</td>
                    <td><span class="badge plan-${getPlanClass(contract.plan)}">${contract.plan}</span></td>
                    <td>Â¥${contract.monthlyFee.toLocaleString()}</td>
                    <td><span class="badge badge-${getStatusClass(contract.status)}">${contract.status}</span></td>
                    <td>${contract.salesPerson}</td>
                    <td><strong style="color: #11998e;">Â¥${contract.margin.toLocaleString()}</strong></td>
                    <td class="actions">
                        <button class="btn btn-sm btn-edit" onclick="editContract('${contract.id}')">ç·¨é›†</button>
                        <button class="btn btn-sm btn-delete" onclick="deleteContract('${contract.id}')">å‰Šé™¤</button>
                    </td>
                `;
            });
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const total = contracts.length;
            const active = contracts.filter(c => c.status === 'æœ‰åŠ¹').length;
            const revenue = contracts.filter(c => c.status === 'æœ‰åŠ¹').reduce((sum, c) => sum + c.monthlyFee, 0);
            const avgMargin = active > 0 ? contracts.filter(c => c.status === 'æœ‰åŠ¹').reduce((sum, c) => sum + c.margin, 0) / active : 0;

            document.getElementById('totalContracts').textContent = total;
            document.getElementById('activeContracts').textContent = active;
            document.getElementById('totalRevenue').textContent = 'Â¥' + revenue.toLocaleString();
            document.getElementById('avgMargin').textContent = 'Â¥' + Math.round(avgMargin).toLocaleString();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
        function openModal() {
            editingId = null;
            document.getElementById('contractForm').reset();
            document.getElementById('contractModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('contractModal').classList.remove('active');
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('contractForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // æ•°å€¤å¤‰æ›
            data.monthlyFee = parseInt(data.monthlyFee);
            data.cost = parseInt(data.cost);
            data.registrationDate = new Date().toISOString().split('T')[0];

            try {
                if (editingId) {
                    await fetch(`/api/contracts/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    await fetch('/api/contracts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                closeModal();
                loadContracts();
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // ç·¨é›†
        async function editContract(id) {
            const contract = contracts.find(c => c.id === id);
            if (!contract) return;

            editingId = id;
            const form = document.getElementById('contractForm');
            
            Object.keys(contract).forEach(key => {
                const input = form.elements[key];
                if (input) input.value = contract[key];
            });

            togglePaymentFields(contract.paymentMethod);
            document.getElementById('contractModal').classList.add('active');
        }

        // å‰Šé™¤
        async function deleteContract(id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                await fetch(`/api/contracts/${id}`, { method: 'DELETE' });
                loadContracts();
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // æ¤œç´¢
        function filterTable() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#contractsBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(input) ? '' : 'none';
            });
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportCSV() {
            const headers = ['å¥‘ç´„ID', 'ä¼šç¤¾å', 'æ‹…å½“è€…', 'ãƒ¡ãƒ¼ãƒ«', 'é›»è©±', 'ä½æ‰€', 'ãƒ—ãƒ©ãƒ³', 'æœˆé¡æ–™é‡‘', 'é–‹å§‹æ—¥', 'æ¬¡å›è«‹æ±‚æ—¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'æ”¯æ‰•æ–¹æ³•', 'å–¶æ¥­æ‹…å½“', 'åŸä¾¡', 'ãƒãƒ¼ã‚¸ãƒ³', 'ç™»éŒ²æ—¥'];
            const rows = contracts.map(c => [
                c.id, c.companyName, c.contactPerson, c.email, c.phone, c.address,
                c.plan, c.monthlyFee, c.startDate, c.nextBillingDate, c.status,
                c.paymentMethod, c.salesPerson, c.cost, c.margin, c.registrationDate
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'contracts_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        // ãƒ—ãƒ©ãƒ³é¸æŠæ™‚ã®æ–™é‡‘è‡ªå‹•å…¥åŠ›
        function updateFee(plan) {
            const feeInput = document.getElementById('monthlyFee');
            const fees = {
                'ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ©ãƒ³': 6980,
                '3ãƒ¶æœˆç„¡æ–™': 6980,
                '6ãƒ¶æœˆç„¡æ–™': 71760,
                '12ãƒ¶æœˆç„¡æ–™': 71760
            };
            feeInput.value = fees[plan] || '';
        }

        // æ”¯æ‰•æ–¹æ³•ã«ã‚ˆã‚‹è¡¨ç¤ºåˆ‡æ›¿
        function togglePaymentFields(method) {
            const cardFields = ['cardNumberField', 'cardExpiryField'];
            const bankFields = ['bankNameField', 'accountNumberField'];
            
            cardFields.forEach(id => {
                document.getElementById(id).style.display = method === 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' ? 'block' : 'none';
            });
            
            bankFields.forEach(id => {
                document.getElementById(id).style.display = method === 'å£åº§æŒ¯æ›¿' ? 'block' : 'none';
            });
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getPlanClass(plan) {
            if (plan.includes('ãƒ“ã‚¸ãƒã‚¹')) return 'business';
            if (plan.includes('3ãƒ¶æœˆ')) return '3month';
            if (plan.includes('6ãƒ¶æœˆ')) return '6month';
            if (plan.includes('12ãƒ¶æœˆ')) return '12month';
            return 'business';
        }

        function getStatusClass(status) {
            if (status === 'æœ‰åŠ¹') return 'active';
            if (status === 'ä¿ç•™ä¸­') return 'pending';
            if (status === 'ä¸­æ–­') return 'suspended';
            return 'active';
        }

        // åˆå›èª­ã¿è¾¼ã¿
        loadContracts();
    </script>
</body>
</html>
